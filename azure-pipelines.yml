trigger:
  - main

pool:
  name: SelfHostedPool

variables:
  workingDirectory: 'terraform'
  environmentServiceConnectionDev: 'connection-rg-dev'  
  environmentServiceConnectionTest: 'connection-test'  
  environmentServiceConnectionProd: 'connection-prod'  

# =====================================================
# üîπ DEV
# =====================================================
stages:
- stage: Dev_Deployment
  displayName: "Deploy Dev Environment"
  jobs:
    - job: Terraform_Dev
      displayName: "Terraform - Dev"
      steps:
        - task: TerraformInstaller@1
          displayName: 'Installer Terraform'
          inputs:
            terraformVersion: '1.7.5'

        - task: PowerShell@2
          displayName: 'Terraform Init (Dev) - backend local'
          inputs:
            targetType: 'inline'
            script: |
              cd $(workingDirectory)
              terraform init -backend=false

        - task: PowerShell@2
          displayName: 'Cr√©er / s√©lectionner Workspace Dev'
          inputs:
            targetType: 'inline'
            script: |
              cd $(workingDirectory)
              $ws = terraform workspace list
              if (-not ($ws -split "`n" | ForEach-Object { $_.Trim() } | Where-Object { $_ -eq "dev" })) {
                  terraform workspace new dev
              }
              terraform workspace select dev

        - task: PowerShell@2
          displayName: 'Terraform Plan (Dev)'
          inputs:
            targetType: 'inline'
            script: |
              terraform -chdir=$(workingDirectory) plan -var-file="dev.tfvars"

        - task: PowerShell@2
          displayName: 'Terraform Apply (Dev)'
          inputs:
            targetType: 'inline'
            script: |
              terraform -chdir=$(workingDirectory) apply -auto-approve -var-file="dev.tfvars"

        # ‚û°Ô∏è Publier les artifacts Dev
        - task: PublishBuildArtifacts@1
          displayName: 'Publish Terraform Artifacts'
          inputs:
            pathToPublish: '$(workingDirectory)'  
            artifactName: 'Terraform_Dev_Output'
            publishLocation: 'Container'

# =====================================================
# üîπ TEST
# =====================================================
- stage: Test_Deployment
  displayName: "Deploy Test Environment"
  dependsOn: Dev_Deployment
  condition: succeeded()
  jobs:
    - job: Terraform_Test
      displayName: "Terraform - Test"
      steps:
        # ‚û°Ô∏è T√©l√©charger l'artifact Dev
        - download: current
          artifact: Terraform_Dev_Output

        - task: PowerShell@2
          displayName: 'Terraform Init (Test) - backend local'
          inputs:
            targetType: 'inline'
            script: |
              cd $(workingDirectory)
              terraform init -backend=false

        - task: PowerShell@2
          displayName: 'Cr√©er / s√©lectionner Workspace Test'
          inputs:
            targetType: 'inline'
            script: |
              cd $(workingDirectory)
              $ws = terraform workspace list
              if (-not ($ws -split "`n" | ForEach-Object { $_.Trim() } | Where-Object { $_ -eq "test" })) {
                  terraform workspace new test
              }
              terraform workspace select test

        - task: PowerShell@2
          displayName: 'Terraform Plan (Test)'
          inputs:
            targetType: 'inline'
            script: |
              terraform -chdir=$(workingDirectory) plan -var-file="test.tfvars"

        - task: PowerShell@2
          displayName: 'Terraform Apply (Test)'
          inputs:
            targetType: 'inline'
            script: |
              terraform -chdir=$(workingDirectory) apply -auto-approve -var-file="test.tfvars"

# =====================================================
# üîπ PROD (avec approbation manuelle)
# =====================================================
- stage: Prod_Deployment
  displayName: "Deploy Prod Environment"
  dependsOn: Test_Deployment
  condition: succeeded()
  jobs:
    - deployment: Terraform_Prod
      displayName: "Terraform - Prod"
      environment: "Production"  # ‚úÖ Approvisionnement manuel avant d√©ploiement
      strategy:
        runOnce:
          deploy:
            steps:
              # ‚û°Ô∏è T√©l√©charger l'artifact Dev (ou Test si tu veux)
              - download: current
                artifact: Terraform_Dev_Output

              - task: PowerShell@2
                displayName: 'Terraform Init (Prod) - backend local'
                inputs:
                  targetType: 'inline'
                  script: |
                    cd $(workingDirectory)
                    terraform init -backend=false

              - task: PowerShell@2
                displayName: 'Cr√©er / s√©lectionner Workspace Prod'
                inputs:
                  targetType: 'inline'
                  script: |
                    cd $(workingDirectory)
                    $ws = terraform workspace list
                    if (-not ($ws -split "`n" | ForEach-Object { $_.Trim() } | Where-Object { $_ -eq "prod" })) {
                        terraform workspace new prod
                    }
                    terraform workspace select prod

              - task: PowerShell@2
                displayName: 'Terraform Plan (Prod)'
                inputs:
                  targetType: 'inline'
                  script: |
                    terraform -chdir=$(workingDirectory) plan -var-file="prod.tfvars"

              - task: PowerShell@2
                displayName: 'Terraform Apply (Prod)'
                inputs:
                  targetType: 'inline'
                  script: |
                    terraform -chdir=$(workingDirectory) apply -auto-approve -var-file="prod.tfvars"
