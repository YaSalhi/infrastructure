trigger:
  - main

pool:
  name: SelfHostedPool

variables:
  workingDirectory: 'terraform'
  environmentServiceConnectionDev: 'connection-rg-dev'  
  environmentServiceConnectionTest: 'connection-test'  
  environmentServiceConnectionProd: 'connection-prod'  

# =====================================================
# ðŸ”¹ DEV
# =====================================================
stages:
- stage: Dev_Deployment
  displayName: "Deploy Dev Environment"
  jobs:
    - job: Terraform_Dev
      displayName: "Terraform - Dev"
      steps:
        - task: TerraformInstaller@1
          displayName: 'Installer Terraform'
          inputs:
            terraformVersion: '1.7.5'

        - task: PowerShell@2
          displayName: 'Terraform Init (Dev) - backend local'
          inputs:
            targetType: 'inline'
            script: |
              cd $(workingDirectory)
              terraform init -backend=false

        - task: PowerShell@2
          displayName: 'CrÃ©er / sÃ©lectionner Workspace Dev'
          inputs:
            targetType: 'inline'
            script: |
              cd $(workingDirectory)
              $ws = terraform workspace list
              if (-not ($ws -split "`n" | ForEach-Object { $_.Trim() } | Where-Object { $_ -eq "dev" })) {
                  terraform workspace new dev
              }
              terraform workspace select dev

        - task: PowerShell@2
          displayName: 'Terraform Plan (Dev)'
          inputs:
            targetType: 'inline'
            script: |
              terraform -chdir=$(workingDirectory) plan -var-file="dev.tfvars" -out=tfplan-dev

        - task: PowerShell@2
          displayName: 'Terraform Apply (Dev)'
          inputs:
            targetType: 'inline'
            script: |
              terraform -chdir=$(workingDirectory) apply -auto-approve tfplan-dev

        # âœ… Publier uniquement les fichiers utiles
        - task: PublishBuildArtifacts@1
          displayName: 'Publier fichiers Terraform utiles'
          inputs:
            pathToPublish: '$(workingDirectory)'
            artifactName: 'Terraform_Dev_Output'
            publishLocation: 'Container'
            # Exclure les fichiers inutiles
          condition: succeeded()

# =====================================================
# ðŸ”¹ TEST
# =====================================================
- stage: Test_Deployment
  displayName: "Deploy Test Environment"
  dependsOn: Dev_Deployment
  condition: succeeded()
  jobs:
    - job: Terraform_Test
      displayName: "Terraform - Test"
      steps:
        # âœ… TÃ©lÃ©charger uniquement les fichiers nÃ©cessaires
        - download: current
          artifact: Terraform_Dev_Output
          patterns: |
            **/*.tf
            **/*.tfvars

        - task: PowerShell@2
          displayName: 'Terraform Init (Test) - backend local'
          inputs:
            targetType: 'inline'
            script: |
              cd $(workingDirectory)
              terraform init -backend=false

        - task: PowerShell@2
          displayName: 'CrÃ©er / sÃ©lectionner Workspace Test'
          inputs:
            targetType: 'inline'
            script: |
              cd $(workingDirectory)
              $ws = terraform workspace list
              if (-not ($ws -split "`n" | ForEach-Object { $_.Trim() } | Where-Object { $_ -eq "test" })) {
                  terraform workspace new test
              }
              terraform workspace select test

        - task: PowerShell@2
          displayName: 'Terraform Plan (Test)'
          inputs:
            targetType: 'inline'
            script: |
              terraform -chdir=$(workingDirectory) plan -var-file="test.tfvars" -out=tfplan-test

        - task: PowerShell@2
          displayName: 'Terraform Apply (Test)'
          inputs:
            targetType: 'inline'
            script: |
              terraform -chdir=$(workingDirectory) apply -auto-approve tfplan-test

# =====================================================
# ðŸ”¹ PROD (avec approbation manuelle)
# =====================================================
- stage: Prod_Deployment
  displayName: "Deploy Prod Environment"
  dependsOn: Test_Deployment
  condition: succeeded()
  jobs:
    - deployment: Terraform_Prod
      displayName: "Terraform - Prod"
      environment: "Production"  # âœ… Validation manuelle
      strategy:
        runOnce:
          deploy:
            steps:
              - download: current
                artifact: Terraform_Dev_Output
                patterns: |
                  **/*.tf
                  **/*.tfvars

              - task: PowerShell@2
                displayName: 'Terraform Init (Prod) - backend local'
                inputs:
                  targetType: 'inline'
                  script: |
                    cd $(workingDirectory)
                    terraform init -backend=false

              - task: PowerShell@2
                displayName: 'CrÃ©er / sÃ©lectionner Workspace Prod'
                inputs:
                  targetType: 'inline'
                  script: |
                    cd $(workingDirectory)
                    $ws = terraform workspace list
                    if (-not ($ws -split "`n" | ForEach-Object { $_.Trim() } | Where-Object { $_ -eq "prod" })) {
                        terraform workspace new prod
                    }
                    terraform workspace select prod

              - task: PowerShell@2
                displayName: 'Terraform Plan (Prod)'
                inputs:
                  targetType: 'inline'
                  script: |
                    terraform -chdir=$(workingDirectory) plan -var-file="prod.tfvars" -out=tfplan-prod

              - task: PowerShell@2
                displayName: 'Terraform Apply (Prod)'
                inputs:
                  targetType: 'inline'
                  script: |
                    terraform -chdir=$(workingDirectory) apply -auto-approve tfplan-prod
