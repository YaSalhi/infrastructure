trigger:
  - main

pool:
  name: SelfHostedPool

variables:
  workingDirectory: 'terraform'
  environmentServiceConnectionDev: 'connection-rg-dev'  
  environmentServiceConnectionTest: 'connection-test'  
  environmentServiceConnectionProd: 'connection-prod'  

stages:
# =====================================================
# üîπ DEV
# =====================================================
- stage: Dev_Deployment
  displayName: "Deploy Dev Environment"
  jobs:
    - job: Terraform_Dev
      displayName: "Terraform - Dev"
      steps:
        - task: TerraformInstaller@1
          displayName: 'Installer Terraform'
          inputs:
            terraformVersion: '1.7.5'

        - task: PowerShell@2
          displayName: 'Terraform Init (Dev) - backend local'
          inputs:
            targetType: 'inline'
            script: |
              cd $(workingDirectory)
              terraform init -backend=false

        - task: PowerShell@2
          displayName: 'Cr√©er / s√©lectionner Workspace Dev'
          inputs:
            targetType: 'inline'
            script: |
              cd $(workingDirectory)
              $ws = terraform workspace list
              if ($ws -notmatch "dev") {
                  terraform workspace new dev
              }
              terraform workspace select dev


        - task: TerraformTaskV3@3
          displayName: 'Terraform Plan (Dev)'
          inputs:
            provider: 'azurerm'
            command: 'plan'
            workingDirectory: '$(workingDirectory)'
            environmentServiceName: '$(environmentServiceConnectionDev)'
            commandOptions: '-var-file=dev.tfvars'

        - task: TerraformTaskV3@3
          displayName: 'Terraform Apply (Dev)'
          inputs:
            provider: 'azurerm'
            command: 'apply'
            workingDirectory: '$(workingDirectory)'
            environmentServiceName: '$(environmentServiceConnectionDev)'
            commandOptions: '-auto-approve -var-file=dev.tfvars'

# =====================================================
# üîπ TEST
# =====================================================
- stage: Test_Deployment
  displayName: "Deploy Test Environment"
  dependsOn: Dev_Deployment
  condition: succeeded()
  jobs:
    - job: Terraform_Test
      displayName: "Terraform - Test"
      steps:
        - task: PowerShell@2
          displayName: 'Terraform Init (Test) - backend local'
          inputs:
            targetType: 'inline'
            script: |
              cd $(workingDirectory)
              terraform init -backend=false

        - task: PowerShell@2
          displayName: 'Cr√©er / s√©lectionner Workspace Test'
          inputs:
            targetType: 'inline'
            script: |
              cd $(workingDirectory)
              $ws = terraform workspace list
              if ($ws -notmatch "test") {
                  terraform workspace new test
              }
              terraform workspace select test


        - task: TerraformTaskV3@3
          displayName: 'Terraform Plan (test)'
          inputs:
            provider: 'azurerm'
            command: 'plan'
            workingDirectory: '$(workingDirectory)'
            environmentServiceName: '$(environmentServiceConnectionTest)'
            commandOptions: '-var-file=test.tfvars'

        - task: TerraformTaskV3@3
          displayName: 'Terraform Apply (test)'
          inputs:
            provider: 'azurerm'
            command: 'apply'
            workingDirectory: '$(workingDirectory)'
            environmentServiceName: '$(environmentServiceConnectionTest)'
            commandOptions: '-auto-approve -var-file=test.tfvars'

# =====================================================
# üîπ PROD (avec approbation manuelle)
# =====================================================
- stage: Prod_Deployment
  displayName: "Deploy Prod Environment"
  dependsOn: Test_Deployment
  condition: succeeded()
  jobs:
    - deployment: Terraform_Prod
      displayName: "Terraform - Prod"
      environment: "Production"  # ‚úÖ cr√©e une approbation manuelle avant le d√©ploiement
      strategy:
        runOnce:
          deploy:
            steps:
              - task: PowerShell@2
                displayName: 'Terraform Init (Prod) - backend local'
                inputs:
                  targetType: 'inline'
                  script: |
                    cd $(workingDirectory)
                    terraform init -backend=false

              - task: PowerShell@2
                displayName: 'Cr√©er / s√©lectionner Workspace Prod'
                inputs:
                  targetType: 'inline'
                  script: |
                    cd $(workingDirectory)
                    $ws = terraform workspace list
                    if ($ws -notmatch "prod") {
                        terraform workspace new prod
                    }
                    terraform workspace select prod



              - task: TerraformTaskV3@3
                displayName: 'Terraform Plan (prod)'
                inputs:
                  provider: 'azurerm'
                  command: 'plan'
                  workingDirectory: '$(workingDirectory)'
                  environmentServiceName: '$(environmentServiceConnectionProd)'
                  commandOptions: '-var-file=prod.tfvars'

              - task: TerraformTaskV3@3
                displayName: 'Terraform Apply (prod)'
                inputs:
                  provider: 'azurerm'
                  command: 'apply'
                  workingDirectory: '$(workingDirectory)'
                  environmentServiceName: '$(environmentServiceConnectionProd)'
                  commandOptions: '-auto-approve -var-file=prod.tfvars'
